<project name="professional.weblogic.ch11.examples.certs" basedir="." default="build">

	<property environment="env"/>

	<target name="build" depends="keys-check" unless="keys-exist">

		<mkdir dir="build/keys"/>
		<antcall target="create-private-key">
			<param name="cert_alias" value="DomainA"/>
			<param name="cert_name"  value="-cn DomainA.bigrez.com"/>
		</antcall>

		<antcall target="create-private-key">
			<param name="cert_alias" value="DomainB"/>
			<param name="cert_name"  value="-cn DomainB.bigrez.com"/>
		</antcall>

		<antcall target="create-private-key">
			<param name="cert_alias" value="someuser"/>
			<param name="cert_name"  value="-e someuser@bigrez.com -cn someuser"/>
		</antcall>

		<antcall target="create-private-key">
			<param name="cert_alias" value="someotheruser"/>
			<param name="cert_name"  value="-e someotheruser@bigrez.com -cn someotheruser"/>
		</antcall>

		<antcall target="create-custom-trust"/>

		<antcall target="create-pkcs12">
			<param name="cert_alias" value="someuser"/>
		</antcall>

		<antcall target="create-pkcs12">
			<param name="cert_alias" value="someotheruser"/>
		</antcall>

		<exec executable="keytool" inputstring="yes">
			<arg line="-importcert -v -file build/keys/DomainA_cert.pem -alias domaina -storepass password -keystore build/keys/DomainB.jks"/>
		</exec>

		<exec executable="keytool" inputstring="yes">
			<arg line="-importcert -v -file build/keys/DomainB_cert.pem -alias domainb -storepass password -keystore build/keys/DomainA.jks"/>
		</exec>


	</target>

	<target name="keys-check">
		<condition property="keys-exist">
			<available file="build/keys/DomainA.jks">
			</available>
		</condition>

	</target>

	<target name="create-private-key">

		<java classname="utils.CertGen" dir="build/keys" fork="true">
			<arg line="-certfile ${cert_alias}_cert -keyfile ${cert_alias}_key -keyfilepass password ${cert_name}"/>
		</java>
		<java classname="utils.ImportPrivateKey" dir="build/keys" fork="true">
			<arg line="-certfile ${cert_alias}_cert.der -keyfile ${cert_alias}_key.der -keyfilepass password -keystore ${cert_alias}.jks -alias ${cert_alias} -storepass password"/>
		</java>

	</target>

	<target name="create-custom-trust">


		<exec executable="keytool">
			<arg line="-importkeystore -srckeystore ${java.home}/lib/security/cacerts -srcstorepass changeit -destkeystore build/keys/ch11CustomTrust.jks -deststorepass password"/>
		</exec>
		<exec executable="keytool" inputstring="yes">
			<arg line="-importcert -v -file ${env.BEA_HOME}/wlserver_10.3/server/lib/CertGenCA.der -alias democa -storepass password -keystore build/keys/ch11CustomTrust.jks"/>
		</exec>
	</target>

	<target name="create-pkcs12">
		<exec executable="keytool" dir="build/keys">
			<arg line="-importkeystore -srcalias ${cert_alias} -srckeystore ${cert_alias}.jks -destkeystore ${cert_alias}.p12 -deststoretype PKCS12 -srcstorepass password -deststorepass password -srckeypass password -destkeypass password"/>
		</exec>

	</target>

	<target name="clean">

		<delete dir="build/keys"/>

	</target>

</project>
